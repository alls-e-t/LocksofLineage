---
title: "Sexual Dimorphism From Natal Coat"
author: "Sarah E Taylor"
date: "2024-01-18"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Loading in Data

```{r Load-R-Libraries, include=FALSE}
# Load in the libraries
library(ape)
library(phylolm)
library(tidyverse)
```


```{r Read-Mammal-Tree-Upham, echo=FALSE}
#read in mammal tree
mammaltree <- read.tree("data/Phylo_Project_Data/MamPhy_BDvr_Completed_v2_tree0000.tre")
summary(mammaltree)
```


```{r Read-Masters-Binary-Data, echo=TRUE}
#read in the data
Binary_traits <- read_csv("data/Phylo_Project_Data/Masters_Binary_Traits.csv")
head(Binary_traits)
```

## Format Data

```{r Format-Binary-Data-SpeciesNames, echo=TRUE}
#combine genus and species names and capitalize first letter
Binary_traits_combined = Binary_traits %>% unite("species",`Genus_names`, `species_name`) %>% mutate(species = str_to_title(species))
head(Binary_traits_combined)
```


```{r Prune-Tree-For-Species-in-Data, echo=TRUE}
# prune tree for species in data
species_not_in_tree=setdiff(mammaltree$tip.label, Binary_traits_combined$species)
pruned.tree<-drop.tip(mammaltree,species_not_in_tree)
summary(pruned.tree)
```


```{r Prune-Data-For-Species-From-Tree, echo=TRUE}
#prune data for species in tree
data_pruned = Binary_traits_combined %>% filter(species %in% pruned.tree$tip.label)
head(data_pruned)
```


```{r Format-Data-Phylolm, echo=TRUE}
#put data into useful form for phylolm
colnames(data_pruned) = gsub(" ", "_", colnames(data_pruned))
data_pruned_rownames = column_to_rownames(data_pruned, var = "species")
head(data_pruned_rownames)
```

## Sexual Dimorphism from Natal Coats Regression

```{r Run-phylolm}
# run phylolm and get summary
SDMfromNC <- phyloglm(Sexual_Dimorphism ~ Natal_Coat, data_pruned_rownames, phy = pruned.tree,method="logistic_MPLE")
summary(SDMfromNC)
```

```{r}
# Filter out rows where DC_Head is not finite
filtered_data <- data_pruned_rownames[is.finite(data_pruned_rownames$Natal_Coat), ]

# Now generate the sequence using the filtered data
Natal_Coat_range <- seq(min(filtered_data$Natal_Coat), max(filtered_data$Natal_Coat), length.out = 236)

# Assuming the rest of your data is consistent and there are no other issues,
# you can proceed with creating the new data frame for predictions
new_data <- data.frame(Natal_Coat = Natal_Coat_range)

# Assuming you have a phyloglm model object named HeadSDM_DC
# and your predictor variable is named DC_Head in data_pruned_rownames

# Step 1: Extract model coefficients
coefficients <- coef(SDMfromNC)

# For simplicity, assuming a model with an intercept and one predictor
beta_0 <- coefficients[1]  # Intercept
beta_1 <- coefficients[2]  # Coefficient for DC_Head

# Step 2: Calculate predicted probabilities manually for each DC_Head value
new_data$predicted_prob <- 1 / (1 + exp(-(beta_0 + beta_1 * new_data$Natal_Coat)))

# Step 3: Plotting (assuming new_data is your prediction data frame)
plot(data_pruned_rownames$Natal_Coat, data_pruned_rownames$Sexual_Dimorphism, col = "red", pch = 16,
     xlab = "Natal_Coat", ylab = "Probability of Sexual_Dimorphism",
     main = "Observed Data and Predicted Probabilities")
lines(new_data$Natal_Coat, new_data$predicted_prob, col = "blue", lwd = 2)

```

```{r}
breaks <- quantile(new_data$predicted_prob, probs = c(0, 1/3, 2/3, 1))

# Create a factor with three levels based on these breakpoints
prob_factor <- cut(new_data$predicted_prob, breaks = breaks, include.lowest = TRUE,
                   labels = c("Low", "Medium", "High"))

# Colors for the three categories
colors <- c("blue", "yellow", "red")

# Plot the tree without tip labels
plot(pruned.tree, show.tip.label = FALSE)

# Add colored tip labels based on the factor levels
tiplabels(pch = 16, col = colors[prob_factor], adj = c(0, 0.5))

# Add a legend to the plot
legend("topleft", title = "Predicted Probability", 
       legend = levels(prob_factor), fill = colors, cex = 0.75)

```

