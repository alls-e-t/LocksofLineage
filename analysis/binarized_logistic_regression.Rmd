---
title: "Binarized Data Logistic Regression"
author: "Sarah E Taylor"
date: "2024-02-13"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Logistic Regression Model Creation

```{r Making a prerequisite table}
prerequisite_mapping <- list(
  ConM = "Natal_coat",
  ConB = "Natal_coat",
  ConD = "Natal_coat",
  incon = "Natal_coat",
  SD_Location_Head = "Sexual_dimorphism",
  Direction_Male = "Sexual_dimorphism",
  Darker_Male = "Sexual_dichromatism"
)

```

```{r Logistic Regression with prerequisites, echo=TRUE, results="hide", message=FALSE, warning=FALSE}
# Load the custom function
source("~/GitHub/LocksofLineage/analysis/binarized_phylogenetic_logistic_regression_function.R")

# Load your dataset
data_file_path <- "~/GitHub/LocksofLineage/data/data_binarized_Feb13.csv"
primate_data <- read_csv(data_file_path)
tree_file_path <- "~/GitHub/LocksofLineage/data/Phylo_Project_Data/MamPhy_BDvr_Completed_v2_tree0000.tre"

# List all variable names (excluding species name if it's there)
variable_names <- colnames(primate_data)[!colnames(primate_data) %in% c("family", "Genus", "species")]

# Initialize a list (or another structure) to store summaries or results
model_results_binarized_prereq <- list()

# Loop over all variable combinations
for (outcome_var in variable_names) {
    for (predictor_var in variable_names) {
        if (outcome_var != predictor_var) {
            #Check if the current predictor_var has a prerequisite
            prerequisite_trait <- ifelse(predictor_var %in% names(prerequisite_mapping), prerequisite_mapping[[predictor_var]], "")
            
            # Run the phylogenetic logistic regression analysis
            model_summary_binarized_prereq <- run_binarized_phylogenetic_logistic_regression(outcome_var, predictor_var, tree_file_path, data_file_path)
            
            if(!exists("model_results_binarized_prereq")) {
  model_results_binarized_prereq <- list()
}
            
            # Store the summary with a meaningful identifier
            model_id <- paste(outcome_var, "vs", predictor_var, sep = "_")
            model_results_binarized_prereq[[model_id]] <- model_summary_binarized_prereq

            # Optionally, print or inspect the summary
             print(model_summary_binarized_prereq)
        }
    }
}
```

## Analyzing the Models
```{r association matrix of binary traits GOOD}
# Initialize the association matrix with the correct dimensions and names
n_variables <- length(variable_names)
association_matrix <- matrix(NA, nrow = n_variables, ncol = n_variables, dimnames = list(variable_names, variable_names))

# Loop over model_results to extract and store coefficients
for (model_id in names(model_results_binarized_prereq)) {
  model_summary_binarized_prereq <- model_results_binarized_prereq[[model_id]]
  
  if (!is.null(model_summary_binarized_prereq) && "summary.phyloglm" %in% class(model_summary_binarized_prereq)) {
    # Extract coefficients matrix
    coefficients_matrix <- model_summary_binarized_prereq$coefficients
    
    # Assuming you're interested in the first predictor's coefficient
    # and that predictor variable names directly match those in variable_names
    predictor_name <- gsub(".*vs_", "", model_id)  # Extract predictor variable name from model_id
    if (predictor_name %in% rownames(coefficients_matrix)) {
      coefficient <- coefficients_matrix[predictor_name, "Estimate"]
      
      # Determine indices for the association matrix based on variable names
      outcome_var <- gsub("_vs.*", "", model_id)  # Extract outcome variable name from model_id
      i <- which(variable_names == outcome_var)
      j <- which(variable_names == predictor_name)
      
      # Populate the association matrix
      if (length(i) == 1 && length(j) == 1) {  # Ensure valid indices
        association_matrix[i, j] <- coefficient
      }
    }
  }
}

# Now, the association matrix should be populated with the coefficients

```

```{r AIC value and best fit model id}
# Assuming `model_results` is a list where each element is a model summary including AIC

# Extract AIC values and model identifiers
aic_values <- sapply(model_results_binarized_prereq, function(summary) summary$aic)  
# Adjust extraction based on your summary structure
model_ids <- names(model_results_binarized_prereq)

# Combine into a data frame for easy sorting and viewing
aic_df <- data.frame(model_id = model_ids, AIC = aic_values)

# Sort by AIC values
aic_sorted <- aic_df[order(aic_df$AIC), ]

# View sorted models by AIC
#print(aic_sorted)

# Identify best models (e.g., top 5 models with lowest AIC)
best_models <- head(aic_sorted, 5)
print(best_models)
```

```{r AIC Plot}
# Create the plot for AIC of models with prerequisites
ggplot(aic_sorted, aes(x = reorder(model_id, AIC), y = AIC)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  coord_flip() +  # Flip coordinates to make the plot horizontal; easier to read model names
  labs(x = "Model", y = "AIC Value", title = "Comparison of Model AIC Values with Prerequisites") +
  geom_text(aes(label = sprintf("%.2f", AIC), hjust = -0.1))  # Add AIC values as text labels
```

```{r Plot the association matrix}
#Basic r plotting
heatmap(association_matrix, Rowv = NA, Colv = NA, col = heat.colors(10), scale = "none")
```
