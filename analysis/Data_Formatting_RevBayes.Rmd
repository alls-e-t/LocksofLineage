---
title: "Data Formatting for RevBayes and Work Flow"
author: "Sarah E Taylor"
date: "2024-06-19"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---


## Set working directory
setwd("/Users/taysarah/Desktop/GitHub/LocksofLineage")

## Load Libraries and Data
```{r Load-Libraries}
# Load libraries
library(ape)
library(phangorn)
library(tidyverse)
```

```{r Read-in-data}
# Read the CSV file
data <- read.csv("data/RevBayes_Data/data_pruned_ordered.csv", row.names = 1)
colnames(data)
```

## Format data
```{r Extract-traits-of-interest}
#Extract natal coat trait and species names
NatalCoatRevBayes <- data[, "natal_coat", drop = FALSE]

#Extract sexual dichromatism trait and species names
SexDichromRevBayes <- data[, "sexual_dichromatism", drop = FALSE]

#Extract conspicuous natal coat trait and species names
NatalCoatConRevBayes <- data[, "natal_coat_conspicuous", drop = FALSE]

#Extract all color traits to get the different stages
AllColorStatesRevBayes <- data[, "all_color_traits", drop = FALSE]
```

```{r Convert-data-frame-to-matrix}
#Convert the data frame into a matrix
NCRB_Matrix <- as.matrix(NatalCoatRevBayes)

SDRB_Matrix <- as.matrix(SexDichromRevBayes)

NCRB_Con_Matrix <- as.matrix(NatalCoatConRevBayes)

ACS_Matrix <- as.matrix(AllColorStatesRevBayes)
```

## Save to NEXUS file format
```{r Function-to-save-matrix-to-NEXUS-file}
# Function to create the nexus file
write_custom_nexus_spaces <- function(data_matrix, file) {
  ntax <- nrow(data_matrix)
  nchar <- ncol(data_matrix)

  # Calculate the maximum length of species names for consistent formatting
  max_name_length <- max(nchar(rownames(data_matrix)))

  con <- file(file, "w")
  writeLines("#NEXUS\n", con)
  writeLines("Begin data;", con)
  writeLines(paste("Dimensions ntax=", ntax, " nchar=", nchar, ";", sep=""), con)
  writeLines('Format datatype=Standard symbols="01" missing=? gap=-;', con)
  writeLines("Matrix", con)

  for (i in 1:ntax) {
    species_name <- rownames(data_matrix)[i]
    species_name_padded <- sprintf("%-*s", max_name_length + 2, species_name)  # Ensure 2 spaces after the name
    state <- paste(data_matrix[i, ], collapse="")
    line <- paste0(species_name_padded, state)
    writeLines(line, con)
  }

  writeLines(";", con)
  writeLines("End;", con)
  close(con)
}
```

```{r Save-NEXUS-files}
write_custom_nexus_spaces(NCRB_Matrix, "data/RevBayes_Data/NC_output_spaces.nex")
write_custom_nexus_spaces(SDRB_Matrix, "data/RevBayes_Data/SD_output_spaces.nex")
write_custom_nexus_spaces(NCRB_Con_Matrix, "data/RevBayes_Data/NC_Con_output.nex")
write_custom_nexus_spaces(ACS_Matrix, "data/RevBayes_Data/ACS_output.nex")

```

## Run RevBayes
```{bash Pipeline-to-run-RevBayes}
#Running RevBayes
#cd ~/Desktop/GitHub/LocksofLineage

#Open RevBayes software
#~/Desktop/GitHub/LocksofLineage/code/rb

#Edit the variables for the specific traits in that study in the CHARACTER slot
#The logs from the .Rev scripts should go into the log folder in the output revbayes folder
#The figures from the .R scripts should go into the plots folder

#Run the code
#source("code/file.Rev")

#Plot the figure
#source("code/file.R")

#Check for convergence
#install.packages("devtools")
#library(devtools)
#install_github("lfabreti/convenience")
#library(convenience)

#check_NC_Con <- checkConvergence( list_files = c("output/RevBayes/log/NC_Con_ERM_run_1.log", "output/RevBayes/log/NC_Con_ERM_run_2.log", "output/RevBayes/log/NC_Con_ase_ERM.tree"))

#check_NC_Con
```

## Different methods used, and associated code:

### Inferring ancestral states and rates of morphological evolution under an equal rates Markov (ERM) model

- mcmc_ase_ERM.Rev

- plot_anc_states.R

### Inferring ancestral states and rates of morphological evolution under an unequal rates (Independent rates) Markov model

- mcmc_ase_freeK.Rev 

- ml_ase_ERM.Rev

- ml_ase_freeK.Rev

~After each ml script record the marginal likelihood estimates into ("output/RevBayes/log/ml_estimates.txt")~

- plot_anc_states_freeK.R

- plot_iid_rates.R

~Right now (June 24, 2024 at 3:25 pm MDT) the above plots arent working, probably due to something with RevGadgets where the functions are breaking, I don't know whats wrong~

### Ancestral State Estimation and Irreversibility - Testing for Irreversibility

- mcmc_ase_irrev.Rev

- plot_anc_states_irrev.R

- plot_irrev.R

### Stochastic Character Mapping and Hidden Rates - Mapping Character Transitions and Testing for Rate Variation

- mcmc_scm_hrm.Rev

- plot_anc_states_hrm.R

- plot_hrm.R

### Correlation among Characters

- mcmc_corr_RJ.Rev

- plot_anc_states_corr_RJ.R

- plot_corr.R

## State-dependent diversification with BiSSE and MuSSE - Inference using the binary/multiple state-dependent speciation and extinction (BiSSE/MuSSE) branching process

- mcmc_BiSSE.Rev

- mcmc_MuSSE.Rev





